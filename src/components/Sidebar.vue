<template>
  <aside :class="['bg-gray-100 h-full p-4 shadow-md transition-all duration-300', collapsed ? 'w-20' : 'w-64']">
    <div class="flex justify-end mb-4">
      <button @click="collapsed = !collapsed" class="text-sm text-gray-600 hover:text-gray-800">
        {{ collapsed ? '≡' : 'x' }}
      </button>
    </div>
    <nav class="flex flex-col gap-2">
      <SidebarLink v-for="item in filteredMenu" :key="item.name" :item="item" :collapsed="collapsed" />
    </nav>
  </aside>
</template>

<script setup>
import { ref, computed } from 'vue';
import { useUserStore } from '@/stores/userStore';
import SidebarLink from './SidebarLink.vue';

const collapsed = ref(false);
const userStore = useUserStore();

const allMenu = [
  { 
    name: 'Dashboard', 
    path: '/dashboard',
    emoji: '🏠',
    roles: ['admin', 'manager', 'user']
  },
  {
    name: 'Pengadaan',
    emoji: '📦',
    roles: ['admin', 'manager', 'user'],
    children: [
      { name: 'Daftar Barang', path: '/daftar-barang', emoji: '📥', roles: ['admin', 'manager', 'user'] },
      { name: 'Pengajuan Barang', path: '/user/pengajuan', emoji: '📝', roles: ['user'] },
      { name: 'Riwayat Pengajuan', path: '/user/riwayat', emoji: '🕘', roles: ['admin', 'manager', 'user'] },
      { name: 'Persetujuan Pengadaan', path: '/admin/persetujuan', emoji: '✅', roles: ['admin'] },
      { name: 'Pengadaan Disetujui', path: '/admin/pengadaan-disetujui', emoji: '📋', roles: ['admin'] },
      { name: 'Pengadaan Manual', path: '/admin/pengadaan-manual', emoji: '✏️', roles: ['admin'] }
    ]
  },
  {
    name: 'Penggunaan Barang',
    emoji: '🔧',
    roles: ['admin', 'manager', 'user'],
    children: [
      { name: 'Kelola Penggunaan', path: '/penggunaan-barang', emoji: '📋', roles: ['user'] },
      { name: 'Stok Tersedia', path: '/stok-tersedia', emoji: '📊', roles: ['admin', 'manager', 'user'] }
    ]
  },
  {
    name: 'Laporan',
    emoji: '📈',
    roles: ['admin', 'manager'],
    children: [
      { name: 'Laporan Pengadaan', path: '/laporan', emoji: '📊', roles: ['admin'] },
      { name: 'Riwayat Cabang', path: '/manager/riwayat-cabang', emoji: '🏢', roles: ['manager'] }
    ]
  },
  {
    name: 'Administrasi',
    emoji: '⚙️',
    roles: ['admin'],
    children: [
      { name: 'Kelola Users', path: '/users', emoji: '👥', roles: ['admin'] },
      { name: 'Jenis Barang', path: '/jenis-barang', emoji: '🏷️', roles: ['admin'] },
      { name: 'Batas Barang', path: '/batas-barang', emoji: '⚠️', roles: ['admin'] },
      { name: 'Batas Pengajuan', path: '/batas-pengajuan', emoji: '📊', roles: ['admin'] }
    ]
  }
];

// This logic is now safer and more robust
const filteredMenu = computed(() => {
  if (!userStore.isAuthenticated) return [];

  const userRoles = userStore.userRoles;

  return allMenu
    .map(item => {
      // Create a new item object to avoid mutation
      const newItem = { ...item };
      
      // If the item has children, filter them first
      if (newItem.children) {
        newItem.children = newItem.children.filter(child =>
          child.roles.some(role => userRoles.includes(role))
        );
      }
      return newItem;
    })
    .filter(item => {
      // Then, filter the parent item based on its roles or if it still has visible children
      const hasAccess = item.roles.some(role => userRoles.includes(role));
      return hasAccess && (!item.children || item.children.length > 0);
    });
});
</script>